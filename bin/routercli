#!/usr/bin/env ruby

require 'rubygems'
require 'bundler'
Bundler.setup :default

require 'gli'
require 'trema'

# routercli command
module RouterCLIApp
  extend GLI::App

  desc 'Show routing table entries'
  arg_name ''
  command :show_table do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, args|
      str = Trema.trema_process('SimpleRouter', options[:socket_dir]).controller.
        show_table()
      print(str.join("\n"))
    end
  end

  desc 'Add a entry'
  arg_name 'dpid dest_addr next_ip'
  command :add do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, args|
      dpid = args[0].hex
      dest_addr = args[1].to_i
      next_ip = args[2].to_i
      Trema.trema_process('SimpleRouter', options[:socket_dir]).controller.
        add_entry(dpid, dest_addr, next_ip)
    end
  end

  desc 'Delete a entry'
  arg_name 'dpid dest_addr next_ip'
  command :delete do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, args|
      dpid = args[0].hex
      dest_addr = args[1].to_i
      next_ip = args[2].to_i
      Trema.trema_process('SimpleRouter', options[:socket_dir]).controller.
        cleate_patch(dpid, dest_addr, next_ip)
    end
  end

  desc 'Show interface list'
  arg_name ''
  command :show_interface do |c|
    c.desc 'Location to find socket files'
    c.flag [:S, :socket_dir], default_value: Trema::DEFAULT_SOCKET_DIR

    c.action do |_global_options, options, args|
      str = Trema.trema_process('SimpleRouter', options[:socket_dir]).controller.
        show_interface()
      print(str.join("\n"))
    end
  end

  exit run(ARGV)
end
